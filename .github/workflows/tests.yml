name: Tests

on:
    push:
        branches: [main, develop]
        paths:
            - "**.py"
            - "pyproject.toml"
            - "uv.lock"
            - "tests/**"
    pull_request:
        branches: [main, develop]
        paths:
            - "**.py"
            - "pyproject.toml"
            - "uv.lock"
            - "tests/**"
    workflow_dispatch:

jobs:
    pytest:
        name: Python Tests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install uv
              uses: astral-sh/setup-uv@v5
              with:
                  enable-cache: true

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libsox-dev

            - name: Install dependencies
              run: |
                  uv sync --extra test

            - name: Create bootstrap token
              run: |
                  TOKEN=$(uv run celestial-tts-create-token --name "CI Test Token" --expires-in 1 --quiet 2>/dev/null)
                  echo "CELESTIAL_TTS_TOKEN=$TOKEN" >> $GITHUB_ENV
                  echo "Created token for testing"

            - name: Start server in background
              run: |
                  uv run celestial-tts --host 127.0.0.1 --port 8080 > server.log 2>&1 &
                  echo $! > server.pid
                  echo "Server started with PID $(cat server.pid)"

            - name: Wait for server to be ready
              run: |
                  echo "Waiting for server to start..."
                  for i in {1..30}; do
                    if curl -s http://127.0.0.1:8080/api/health > /dev/null 2>&1; then
                      echo "Server is ready!"
                      exit 0
                    fi
                    echo "Attempt $i: Server not ready yet, waiting..."
                    sleep 2
                  done
                  echo "Server failed to start within 60 seconds"
                  cat server.log
                  exit 1

            - name: Run pytest tests
              run: |
                  uv run pytest tests/test_openai_client.py -v --tb=short
              env:
                  CELESTIAL_TTS_BASE_URL: http://127.0.0.1:8080/api/v1

            - name: Stop server
              if: always()
              run: |
                  if [ -f server.pid ]; then
                    kill $(cat server.pid) || true
                    rm server.pid
                  fi

            - name: Upload server logs
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: server-logs-pytest
                  path: server.log

    hurl:
        name: HTTP Tests (Hurl)
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install uv
              uses: astral-sh/setup-uv@v5
              with:
                  enable-cache: true

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libsox-dev

            - name: Install dependencies
              run: |
                  uv sync

            - name: Install hurl
              run: |
                  HURL_VERSION=5.0.1
                  curl -LO https://github.com/Orange-OpenSource/hurl/releases/download/${HURL_VERSION}/hurl_${HURL_VERSION}_amd64.deb
                  sudo dpkg -i hurl_${HURL_VERSION}_amd64.deb
                  hurl --version

            - name: Create bootstrap token
              run: |
                  TOKEN=$(uv run celestial-tts-create-token --name "CI Test Token" --expires-in 1 --quiet 2>/dev/null)
                  echo "token=$TOKEN" > tests/hurl/vars.env
                  echo "base_url=http://127.0.0.1:8080" >> tests/hurl/vars.env
                  echo "Created token for testing"

            - name: Start server in background
              run: |
                  uv run celestial-tts --host 127.0.0.1 --port 8080 > server.log 2>&1 &
                  echo $! > server.pid
                  echo "Server started with PID $(cat server.pid)"

            - name: Wait for server to be ready
              run: |
                  echo "Waiting for server to start..."
                  for i in {1..30}; do
                    if curl -s http://127.0.0.1:8080/api/health > /dev/null 2>&1; then
                      echo "Server is ready!"
                      exit 0
                    fi
                    echo "Attempt $i: Server not ready yet, waiting..."
                    sleep 2
                  done
                  echo "Server failed to start within 60 seconds"
                  cat server.log
                  exit 1

            - name: Run hurl tests
              run: |
                  hurl --variables-file tests/hurl/vars.env --test --max-time 300 --jobs 1 tests/hurl/*.hurl

            - name: Stop server
              if: always()
              run: |
                  if [ -f server.pid ]; then
                    kill $(cat server.pid) || true
                    rm server.pid
                  fi

            - name: Upload server logs
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: server-logs-hurl
                  path: server.log
